<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emergency Alert | Your Health Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" type="text/css" />
    <script type="module" src="/src/main.js"></script>
    <style>
      .emergency-pulse {
        animation: emergency-pulse 1s infinite;
      }
      
      @keyframes emergency-pulse {
        0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(248, 113, 113, 0); }
        100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); }
      }

      .emergency-bg {
        background: linear-gradient(45deg, #fee2e2, #fecaca);
      }
    </style>
  </head>
  <body class="emergency-bg min-h-screen">
    <!-- Emergency Header -->
    <div class="bg-error text-error-content p-4">
      <div class="container mx-auto">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8 mr-3 animate-pulse">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
            </svg>
            <h1 class="text-2xl font-bold" data-i18n="emergency.title">EMERGENCY ALERT SYSTEM</h1>
          </div>
          <div class="flex items-center">
            <!-- Language toggle -->
            <button id="language-toggle" class="btn btn-ghost btn-circle mr-2 text-error-content">
              ÿπÿ±ÿ®Ÿä
            </button>
            <a href="dashboard.html" class="btn btn-ghost text-error-content">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
              <span data-i18n="common.close">Close</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <main class="container mx-auto px-4 py-8">
      <!-- Emergency Actions -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Call Emergency Services -->
        <div class="card bg-error text-error-content shadow-xl emergency-pulse">
          <div class="card-body text-center">
            <div class="text-6xl mb-4">üö®</div>
            <h2 class="card-title justify-center mb-2" data-i18n="emergency.call.title">CALL 911</h2>
            <p class="mb-4" data-i18n="emergency.call.desc">For immediate life-threatening emergencies</p>
            <button onclick="callEmergency()" class="btn btn-error-content btn-lg w-full text-error font-bold">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
              </svg>
              <span data-i18n="emergency.call.button">CALL NOW</span>
            </button>
          </div>
        </div>

        <!-- Share Location -->
        <div class="card bg-warning text-warning-content shadow-xl">
          <div class="card-body text-center">
            <div class="text-6xl mb-4">üìç</div>
            <h2 class="card-title justify-center mb-2" data-i18n="emergency.location.title">Share Location</h2>
            <p class="mb-4" data-i18n="emergency.location.desc">Send your current location to emergency contacts</p>
            <button onclick="shareLocation()" class="btn btn-warning-content btn-lg w-full text-warning font-bold">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
              </svg>
              <span data-i18n="emergency.location.button">SHARE LOCATION</span>
            </button>
          </div>
        </div>

        <!-- Medical Alert -->
        <div class="card bg-info text-info-content shadow-xl">
          <div class="card-body text-center">
            <div class="text-6xl mb-4">üè•</div>
            <h2 class="card-title justify-center mb-2" data-i18n="emergency.medical.title">Medical Alert</h2>
            <p class="mb-4" data-i18n="emergency.medical.desc">Send medical information to first responders</p>
            <button onclick="sendMedicalAlert()" class="btn btn-info-content btn-lg w-full text-info font-bold">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
              </svg>
              <span data-i18n="emergency.medical.button">SEND ALERT</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Emergency Contacts -->
      <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
          <h2 class="card-title mb-4" data-i18n="emergency.contacts.title">Emergency Contacts</h2>
          <div id="emergency-contacts" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Emergency contacts will be loaded here -->
            <div class="flex justify-center items-center py-8">
              <span class="loading loading-spinner loading-lg text-primary"></span>
            </div>
          </div>
          <div class="divider"></div>
          <button onclick="addEmergencyContact()" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            <span data-i18n="emergency.contacts.add">Add Emergency Contact</span>
          </button>
        </div>
      </div>

      <!-- Medical Information -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title mb-4" data-i18n="emergency.medical.info.title">Medical Information</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-semibold mb-2" data-i18n="emergency.medical.conditions">Medical Conditions:</h3>
              <div id="medical-conditions" class="space-y-1 text-sm">
                <div class="text-base-content/60" data-i18n="emergency.medical.loading">Loading medical information...</div>
              </div>
            </div>
            <div>
              <h3 class="font-semibold mb-2" data-i18n="emergency.medical.medications">Current Medications:</h3>
              <div id="current-medications" class="space-y-1 text-sm">
                <div class="text-base-content/60" data-i18n="emergency.medical.loading">Loading medication information...</div>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <button onclick="updateMedicalInfo()" class="btn btn-outline btn-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
              </svg>
              <span data-i18n="emergency.medical.update">Update Medical Information</span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Emergency Contact Modal -->
    <div id="contact-modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4" data-i18n="emergency.contacts.add.title">Add Emergency Contact</h3>
        <form id="contact-form" class="space-y-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text" data-i18n="emergency.contacts.name">Full Name</span>
            </label>
            <input type="text" name="name" class="input input-bordered" required />
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text" data-i18n="emergency.contacts.phone">Phone Number</span>
            </label>
            <input type="tel" name="phone" class="input input-bordered" required />
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text" data-i18n="emergency.contacts.relationship">Relationship</span>
            </label>
            <select name="relationship" class="select select-bordered">
              <option value="family" data-i18n="emergency.contacts.family">Family Member</option>
              <option value="friend" data-i18n="emergency.contacts.friend">Friend</option>
              <option value="doctor" data-i18n="emergency.contacts.doctor">Doctor</option>
              <option value="other" data-i18n="emergency.contacts.other">Other</option>
            </select>
          </div>
        </form>
        <div class="modal-action">
          <button type="submit" form="contact-form" class="btn btn-primary" data-i18n="common.save">Save</button>
          <button class="btn" onclick="closeContactModal()" data-i18n="common.cancel">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      let emergencyContacts = [];

      // Emergency action functions
      function callEmergency() {
        if (confirm('This will call emergency services (911). Proceed only if this is a real emergency.')) {
          // In a real app, this would make an actual call
          window.location.href = 'tel:911';
        }
      }

      function shareLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              const locationUrl = `https://maps.google.com/maps?q=${lat},${lng}`;
              
              // Share location with emergency contacts
              const message = `EMERGENCY: I need help! My current location is: ${locationUrl}`;
              
              // In a real app, this would send SMS/notifications to emergency contacts
              if (navigator.share) {
                navigator.share({
                  title: 'Emergency Location',
                  text: message,
                  url: locationUrl
                });
              } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(message).then(() => {
                  window.ui?.showToast('Location copied to clipboard', 'success');
                });
              }
            },
            (error) => {
              window.ui?.showToast('Unable to get location. Please enable GPS.', 'error');
            }
          );
        } else {
          window.ui?.showToast('Geolocation is not supported by this browser.', 'error');
        }
      }

      function sendMedicalAlert() {
        // In a real app, this would compile medical information and send it
        window.ui?.showToast('Medical alert sent to emergency services', 'success');
      }

      // Load emergency contacts
      async function loadEmergencyContacts() {
        try {
          const contacts = localStorage.getItem('emergency-contacts');
          emergencyContacts = contacts ? JSON.parse(contacts) : [];
          renderEmergencyContacts();
        } catch (error) {
          console.error('Failed to load emergency contacts:', error);
        }
      }

      function renderEmergencyContacts() {
        const container = document.getElementById('emergency-contacts');
        
        if (emergencyContacts.length === 0) {
          container.innerHTML = '<div class="col-span-full text-center text-base-content/60" data-i18n="emergency.contacts.empty">No emergency contacts added yet</div>';
          return;
        }

        container.innerHTML = emergencyContacts.map(contact => `
          <div class="card bg-base-200 compact">
            <div class="card-body">
              <h4 class="font-semibold">${contact.name}</h4>
              <p class="text-sm text-base-content/70">${contact.relationship}</p>
              <div class="flex justify-between items-center mt-2">
                <a href="tel:${contact.phone}" class="btn btn-sm btn-primary">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
                  </svg>
                  <span data-i18n="emergency.contacts.call">Call</span>
                </a>
                <button onclick="deleteContact('${contact.id}')" class="btn btn-sm btn-ghost text-error">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      function addEmergencyContact() {
        document.getElementById('contact-modal').classList.add('modal-open');
      }

      function closeContactModal() {
        document.getElementById('contact-modal').classList.remove('modal-open');
        document.getElementById('contact-form').reset();
      }

      // Handle contact form submission
      document.getElementById('contact-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const contact = {
          id: Date.now().toString(),
          name: formData.get('name'),
          phone: formData.get('phone'),
          relationship: formData.get('relationship')
        };

        emergencyContacts.push(contact);
        localStorage.setItem('emergency-contacts', JSON.stringify(emergencyContacts));
        
        renderEmergencyContacts();
        closeContactModal();
        window.ui?.showToast('Emergency contact added successfully', 'success');
      });

      function deleteContact(id) {
        if (confirm('Are you sure you want to delete this emergency contact?')) {
          emergencyContacts = emergencyContacts.filter(c => c.id !== id);
          localStorage.setItem('emergency-contacts', JSON.stringify(emergencyContacts));
          renderEmergencyContacts();
          window.ui?.showToast('Emergency contact deleted', 'success');
        }
      }

      // Load medical information
      async function loadMedicalInfo() {
        try {
          // Load prescriptions for current medications
          const prescriptions = await window.offline?.getCombinedPrescriptions() || [];
          const medications = prescriptions.slice(0, 5).map(p => p.medication_name).filter(Boolean);
          
          document.getElementById('current-medications').innerHTML = medications.length ? 
            medications.map(med => `<div>‚Ä¢ ${med}</div>`).join('') :
            '<div class="text-base-content/60">No current medications recorded</div>';

          // Mock medical conditions - in a real app, this would come from user data
          const conditions = ['No major medical conditions recorded'];
          document.getElementById('medical-conditions').innerHTML = 
            conditions.map(condition => `<div>‚Ä¢ ${condition}</div>`).join('');

        } catch (error) {
          console.error('Failed to load medical info:', error);
        }
      }

      function updateMedicalInfo() {
        window.ui?.showToast('Medical information update feature coming soon!', 'info');
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', () => {
        loadEmergencyContacts();
        
        // Load medical info after modules are ready
        setTimeout(() => {
          loadMedicalInfo();
        }, 1000);
      });
    </script>
  </body>
</html>
